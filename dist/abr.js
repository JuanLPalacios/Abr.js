!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.abr=e():t.abr=e()}(this,(()=>(()=>{"use strict";var t={d:(e,n)=>{for(var r in n)t.o(n,r)&&!t.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:n[r]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};t.r(e),t.d(e,{INT16_MAX:()=>s,abrBrushes:()=>i,abrReach8BimSection:()=>d,abrReadContent:()=>f,abrSupportedContent:()=>g,charCodeComparison:()=>l,loadAbrBrush:()=>h,loadAbrBrushes:()=>c,loadAbrFromArrayBuffer:()=>u});class n{constructor(t){this.dataView=new DataView(t),this.offset=0}readRawData(t,e){for(;t.length>0;)t.pop();const n=this.offset,r=this.offset+e;for(;!this.atEnd()&&this.offset<r;)t.push(this.getUint8());return this.offset-n}data(){return this.dataView.buffer}getPos(){return this.offset}setPos(t){this.offset=t}size(){return this.dataView.byteLength}atEnd(){return this.offset>=this.dataView.byteLength}getUint8(){const t=this.offset;return this.offset+=1,this.dataView.getUint8(t)}getUint16(){const t=this.offset;return this.offset+=2,this.dataView.getUint16(t)}getUint32(){const t=this.offset;return this.offset+=4,this.dataView.getUint32(t)}getInt16(){const t=this.offset;return this.offset+=2,this.dataView.getInt16(t)}getChar(){return String.fromCharCode(this.getUint8())}}var r=function(t,e,n,r){return new(n||(n=Promise))((function(s,o){function i(t){try{c(r.next(t))}catch(t){o(t)}}function a(t){try{c(r.throw(t))}catch(t){o(t)}}function c(t){var e;t.done?s(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(i,a)}c((r=r.apply(t,e||[])).next())}))};const s=65535,o=document.createElement("canvas"),i={map:{},get(t){return this.map[t]},set(t,e){this.map[t]=e},clear(){this.map={}},list(){return Object.values(this.map)}};function a(t){return{brushType:2,brushTipImage:o,md5Sum:new ArrayBuffer(0),name:t,valid:!1,spacing:1,antiAliasing:!0}}function c(t){return r(this,void 0,void 0,(function*(){return u(yield new Promise(((e,n)=>{const r=new FileReader;r.onload=function(t){t.target&&t.target.result&&"string"!=typeof t.target.result?e(t.target.result):n()},r.readAsArrayBuffer(t)})),t.name)}))}function u(t,e){return r(this,void 0,void 0,(function*(){const r=new n(t);try{const t=f(r);if(!g(t))throw new Error(`ERROR: unable to decode abr format version ${t.version}(subver ${t.subversion})`);if(0==t.count)throw new Error(`ERROR: no brushes found in ${e}`);for(let n=0;n<t.count;n++)-1==(yield h(r,t,e,0,n+1))&&console.warn(`Warning: problem loading brush #${n} in ${e}`);const n=i.list();return i.clear(),n}catch(t){throw console.error(t),new Error(`Error: cannot parse ABR file: ${e}`)}}))}const f=t=>{const e={count:0,subversion:0,version:0};switch(e.version=t.getUint16(),e.subversion=0,e.count=0,e.version){case 1:case 2:e.count=t.getUint16();break;case 6:e.subversion=t.getUint16(),e.count=function(t,e){let n,r;if(!g(e))return 0;const s=t.getPos();try{d(t,"samp")}catch(e){return t.setPos(s),0}const o=t.getUint32()+t.getPos();if(o<0||o>t.size())return 0;const i=t.getPos();let a=0;for(;!t.atEnd()&&t.getPos()<o;){for(n=t.getUint32(),r=n;r%4!=0;)r++;const e=t.getPos()+r;if(!(e>0&&e<t.size()))return 0;t.setPos(e),a++}return t.setPos(i),a}(t,e)}return e};function g(t){switch(t.version){case 1:case 2:return!0;case 6:if(1==t.subversion||2==t.subversion)return!0}return!1}function d(t,e){let n=0;for(;!t.atEnd();){const r=[],s=[];let o;if(o=t.readRawData(r,4),4!=o)throw new Error("Error: Cannot read 8BIM tag ");if(l(r,"8BIM",4))throw new Error(`Error: Start tag not 8BIM but ${String.fromCharCode(...r)} at position ${t.getPos()}`);if(o=t.readRawData(s,4),4!=o)throw new Error("Error: Cannot read 8BIM tag name");if(String.fromCharCode(...s)==e)return;n=t.getUint32(),t.setPos(t.getPos()+n)}}function l(t,e,n){if(t.length<n||e.length<n)return!0;for(let r=0;r<n;r++)if(e.charCodeAt(r)!==t[r])return!0;return!1}function h(t,e,o,c,u){return r(this,void 0,void 0,(function*(){let c=-1;switch(e.version){case 1:case 2:c=yield function(t,e,s,o,c){return r(this,void 0,void 0,(function*(){let r="",o=-1;const u=t.getUint16(),f=t.getUint32(),g=t.getPos()+f;if(1==u){t.setPos(t.getPos()+4);const e=t.getUint16(),n=t.getUint16(),a=t.getUint16(),f=t.getInt16(),d=t.getUint16();r=b(s,c),i.set(r,{brushType:u,spacing:e,diameter:n,roundness:a,angle:f,hardness:d,name:r}),t.setPos(g),o=1}else if(2==u){t.setPos(t.getPos()+4);const u=t.getUint16();2==e.version&&(r=function(t){let e;const n=t.getUint32();if(0==n)return"";const r=n,s=[];for(e=0;e<r;e++)s[e]=t.getUint16();return String.fromCharCode(...s)}(t)),null===r&&(r=b(s,c));const f=!!t.getUint8();t.setPos(t.getPos()+8);const d=t.getUint32(),l=t.getUint32(),h=t.getUint32(),m=t.getUint32(),U=t.getUint16(),v=t.getUint8(),y=m-l,P=h-d,j=y*(U>>3)*P;if(P>16384)console.warn("WARNING: wide brushes not supported"),t.setPos(g);else{const e=[];let s;v?p(t,e,P):t.readRawData(e,j);const c=w(e,y,P);if(Object.keys(i.map).includes(r))s=a(r);else{s=a(r);const t=new n(new ArrayBuffer(0));s=Object.assign(Object.assign({},s),{md5Sum:yield crypto.subtle.digest("SHA-256",t.data())})}s=Object.assign(Object.assign({},s),{brushTipImage:c}),s=Object.assign(Object.assign({},s),{valid:!0}),s=Object.assign(Object.assign({},s),{name:r,spacing:u,antiAliasing:f}),i.set(r,s),o=1}}else console.warn("Unknown ABR brush type, skipping."),t.setPos(g);return o}))}(t,e,o,0,u);break;case 6:c=yield function(t,e,o,c,u){return r(this,void 0,void 0,(function*(){let r=0,c=0,f=-1;for(r=t.getUint32(),c=r;c%4!=0;)c++;const g=t.getPos()+c;t.setPos(t.getPos()+37),1==e.subversion?t.setPos(t.getPos()+10):t.setPos(t.getPos()+264);const d=t.getUint32(),l=t.getUint32(),h=t.getUint32(),m=t.getUint32(),U=t.getUint16(),v=t.getUint8(),y=m-l,P=h-d,j=y*(U>>3)*P,O=b(o,u),E=[];if(v?p(t,E,P):t.readRawData(E,j),y<s&&P<s){let t;const e=w(E,y,P);if(Object.keys(i.map).includes(O))t=a(O);else{t=a(O);const e=new n(new ArrayBuffer(0));t=Object.assign(Object.assign({},t),{md5Sum:yield crypto.subtle.digest("SHA-256",e.data())})}t=Object.assign(Object.assign({},t),{brushTipImage:e}),t=Object.assign(Object.assign({},t),{valid:!0}),t=Object.assign(Object.assign({},t),{name:O}),i.set(O,t)}return t.setPos(g),f=u,f}))}(t,e,o,0,u)}return c}))}function b(t,e){const n=t.split(""),r=t.lastIndexOf(".");return n.splice(r,4),n.join("")+"_"+e}function p(t,e,n){const r=Array.from({length:n},(()=>0));for(let e=0;e<n;e++)r[e]=t.getUint16();for(let s=0;s<n;s++)for(let n=0;n<r[s]&&!t.atEnd();){let r=t.getUint8();if(n++,r>=128&&(r-=256),r<0){if(-128==r)continue;r=1-r;const s=t.getUint8();if(t.atEnd())break;n++;for(let t=0;t<r;t++)e.push(s)}else for(let s=0;s<r+1;s++,n++){const n=t.getUint8();if(e.push(n),t.atEnd())break}}return 0}function w(t,e,n){const r=document.createElement("canvas");r.width=e,r.height=n;const s=r.getContext("2d");if(!s)throw new Error("Failed to construct context.");const o=s.getImageData(0,0,e,n);let i=0,a=0;for(let r=0;r<n;r++)for(let n=0;n<e;n++,i++){a=255-t[i];for(let t=0;t<3;t++)o.data[r*e*4+4*n+t]=a;o.data[r*e*4+4*n+3]=255}return s.putImageData(o,0,0),r}return e})()));
//# sourceMappingURL=abr.js.map